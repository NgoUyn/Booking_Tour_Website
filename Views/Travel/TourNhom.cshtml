@using Newtonsoft.Json
@model Tour_Website.ViewModels.TourNhomViewModel

@{
    ViewBag.Title = "Group Tours";
}
<h2>Group Tours</h2>
<p>Join guided group tours for hassle-free adventures with expert leaders and fellow travelers.</p>

<link href="~/Content/TuTuc.css" rel="stylesheet" />
<style>
	.tour-toolbar {
		margin-bottom: 1.5rem;
	}
	.tour-card {
		border-radius: 16px;
		overflow: hidden;
		box-shadow: 0 20px 35px rgba(0,0,0,0.08);
		transition: transform 0.3s ease;
	}
	.tour-card:hover {
		transform: translateY(-6px);
	}
	.tour-card img {
		height: 220px;
		object-fit: cover;
	}
	.tour-card .card-body {
		min-height: 270px;
	}
	.badge-sold {
		font-size: 0.8rem;
	}
	.itinerary-day {
		border-bottom: 1px solid #eaeaea;
		padding-bottom: 0.5rem;
		margin-bottom: 0.75rem;
	}
	.cart-toast {
		position: fixed;
		top: 1rem;
		right: 1rem;
		padding: 0.75rem 1rem;
		border-radius: 0.75rem;
		color: #fff;
		font-weight: 600;
		display: none;
		box-shadow: 0 10px 30px rgba(0,0,0,0.15);
		z-index: 1500;
	}
	.cart-toast.visible {
		display: block;
	}
</style>

<div id="cartToast" class="cart-toast bg-success"></div>

<div class="tour-toolbar d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
	<div class="d-flex gap-2 flex-fill">
		<input type="text" id="tourSearch" class="form-control" placeholder="Tìm tour theo tên..." />
		<button class="btn btn-primary" id="tourSearchBtn">Search</button>
	</div>
	<select id="tourCategory" class="form-select w-100 w-md-auto">
		<option value="all">Tất cả danh mục</option>
		@foreach (var category in Model.Categories)
		{
			<option value="@category.Slug">@category.Name</option>
		}
	</select>
</div>

<div id="tourCards" class="row g-4"></div>

<!-- Detail modal -->
<div class="modal fade" id="tourDetailModal" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content border-0 shadow">
			<div class="modal-header border-bottom">
				<h5 class="modal-title" id="tourDetailTitle"></h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body" id="tourDetailBody"></div>
			<div class="modal-footer border-top">
				<span class="badge bg-success me-auto" id="tourDetailSlots"></span>
				<button type="button" class="btn btn-outline-secondary" id="modalAddButton">Thêm vào giỏ hàng</button>
				<button type="button" class="btn btn-primary">Mua tour</button>
			</div>
		</div>
	</div>
</div>

@section scripts {
	<script>
		const addToCartUrl = '@Url.Action("AddToCart", "Travel")';
		const cartToast = document.getElementById('cartToast');
		const cartCountEl = document.getElementById('cart-count');

		const tourData = @Html.Raw(JsonConvert.SerializeObject(Model.Tours));
		const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
		const tourCardsEl = document.getElementById('tourCards');
		const searchInput = document.getElementById('tourSearch');
		const searchBtn = document.getElementById('tourSearchBtn');
		const categorySelect = document.getElementById('tourCategory');
		const modal = new bootstrap.Modal(document.getElementById('tourDetailModal'));
		const modalTitle = document.getElementById('tourDetailTitle');
		const modalBody = document.getElementById('tourDetailBody');
		const modalSlots = document.getElementById('tourDetailSlots');

		function renderTours(list) {
			if (!list.length) {
				tourCardsEl.innerHTML = '<div class="col-12"><p class="text-muted text-center py-4">Hiện không có tour phù hợp.</p></div>';
				return;
			}

			tourCardsEl.innerHTML = list.map(tour => `
				<div class="col-12 col-md-6 col-xl-4">
					<div class="card tour-card">
						<img src="${tour.AvatarUrl}" alt="${tour.TourName}" class="card-img-top">
						<div class="card-body d-flex flex-column">
							<p class="badge bg-warning text-dark badge-sold align-self-start mb-2">Đã có ${tour.SoldCount} lượt đặt</p>
							<h5 class="card-title">${tour.TourName}</h5>
							<p class="card-meta text-muted mb-2">${tour.CategoryName}</p>
							<p class="card-text flex-grow-1 text-sm">${tour.Description}</p>
							<ul class="list-unstyled text-sm text-secondary mb-3">
								<li>Thời gian: ${tour.Duration}</li>
								<li>Giá từ: ${formatter.format(tour.Price)}</li>
								<li>Còn ${tour.AvailableSlots} / ${tour.TotalSlots} chỗ</li>
							</ul>
							<div class="d-grid gap-2">
								<button class="btn btn-outline-primary detail-btn w-100" data-tour='${encodeURIComponent(JSON.stringify(tour))}'>View details</button>
							</div>
						</div>
					</div>
				</div>
			`).join('');
			bindDetailButtons();
		}

		function handleAddToCart(tourId) {
			fetch(addToCartUrl, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ tourId: tourId, quantity: 1 })
			})
				.then(res => res.json())
				.then(data => {
					if (data.success) {
						showCartMessage(data.message, true);
						if (cartCountEl) {
							cartCountEl.textContent = data.cartCount ?? 0;
						}
					} else {
						showCartMessage(data.message, false);
					}
				})
				.catch(() => {
					showCartMessage('Có lỗi khi thêm vào giỏ hàng.', false);
				});
		}

		function showCartMessage(text, success = true) {
			cartToast.textContent = text;
			cartToast.classList.remove('bg-success', 'bg-danger');
			cartToast.classList.add(success ? 'bg-success' : 'bg-danger');
			cartToast.classList.add('visible');
			setTimeout(() => cartToast.classList.remove('visible'), 3000);
		}

		function bindDetailButtons() {
			document.querySelectorAll('.detail-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const tour = JSON.parse(decodeURIComponent(btn.dataset.tour));
					currentModalTourId = tour.TourId;
					modalTitle.textContent = tour.TourName;
					modalSlots.textContent = `Còn ${tour.AvailableSlots} / ${tour.TotalSlots} chỗ`;
					modalBody.innerHTML = `
						<div class="mb-3">
							<label class="form-label fw-semibold">Mô tả</label>
							<p>${tour.Description}</p>
						</div>
						<div class="mb-3">
							<label class="form-label fw-semibold">Lịch trình</label>
							${tour.Itinerary.length ? tour.Itinerary.map(item => `
								<div class="itinerary-day">
									<div class="fw-bold">Ngày ${item.DayNumber} – ${item.Title}</div>
									<p class="mb-1">${item.Description}</p>
								</div>
							`).join('') : '<p class="text-muted">Chưa có lịch trình cụ thể.</p>'}
						</div>
						<div class="d-flex flex-wrap align-items-center gap-3">
							<span class="fs-5 fw-semibold text-primary">${formatter.format(tour.Price)}</span>
							<span class="badge bg-success">Thời gian: ${tour.Duration}</span>
						</div>
					`;
					modal.show();
				});
			});
		}

		function filterTours() {
			const term = searchInput.value.trim().toLowerCase();
			const category = categorySelect.value;
			const filtered = tourData.filter(tour => {
				const matchesTerm = !term || tour.TourName.toLowerCase().includes(term);
				const matchesCategory = category === 'all' ||
					tour.CategoryName.replace(/\s+/g, '-').toLowerCase() === category;
				return matchesTerm && matchesCategory;
			});
			renderTours(filtered);
		}

		searchBtn.addEventListener('click', filterTours);
		searchInput.addEventListener('input', filterTours);
		categorySelect.addEventListener('change', filterTours);

		renderTours(tourData);
	</script>
}

