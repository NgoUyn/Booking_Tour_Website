@using Newtonsoft.Json;
@model Tour_Website.ViewModels.TourNhomViewModel

@{
	ViewBag.Title = "Group Tours";
}

<link href="~/Content/TuTuc.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />

<div class="tour-search-hero">
	<div class="container">
		<h2 class="text-white mb-3">Tìm Tour Nhóm Hoàn Hảo</h2>
		<p class="text-light">Khám phá các tour du lịch nhóm đặc biệt với giá tốt nhất</p>
	</div>
</div>

<div class="container">
	<div class="search-form-container">
		<div class="search-tabs">
			<button class="active" data-tab="tour">Search Tour</button>
			<button data-tab="hotel">Hotel</button>
		</div>

		<div class="search-form-row">
			<div class="form-group-search">
				<label>Tên Tour / Địa Điểm</label>
				<input type="text" id="tourSearch" placeholder="Tìm tour theo tên..." class="form-control">
			</div>
			<div class="form-group-search">
				<label>Ngày Bắt Đầu</label>
				<input type="text" id="startDate" placeholder="Chọn ngày..." class="form-control datepicker">
			</div>
			<div class="form-group-search">
				<label>Ngày Kết Thúc</label>
				<input type="text" id="endDate" placeholder="Chọn ngày..." class="form-control datepicker">
			</div>
			<div class="form-group-search">
				<label>Giá Tối Đa</label>
				<select id="priceLimit" class="form-control">
					<option value="0">Tất cả</option>
					<option value="2000000">2 Triệu</option>
					<option value="5000000">5 Triệu</option>
					<option value="10000000">10 Triệu</option>
					<option value="20000000">20 Triệu</option>
				</select>
			</div>
			<button class="btn-search-large" id="tourSearchBtn">Search</button>
		</div>
	</div>

	<div class="tour-grid">
		<div id="tourCards" class="row g-4"></div>
	</div>
</div>

<!-- Detail modal -->
<div class="modal fade" id="tourDetailModal" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content border-0 shadow">
			<div class="modal-header border-bottom">
				<h5 class="modal-title" id="tourDetailTitle"></h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body" id="tourDetailBody"></div>
			<div class="modal-footer border-top">
				<span class="badge bg-success me-auto" id="tourDetailSlots"></span>
				<button type="button" class="btn btn-outline-secondary" id="modalAddCartButton">Thêm vào giỏ hàng</button>
				<button type="button" class="btn btn-primary">Mua tour</button>
			</div>
		</div>
	</div>
</div>

<div id="cartToast" class="cart-toast bg-success"></div>

@section scripts {
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
	<script>
		const tourData = @Html.Raw(JsonConvert.SerializeObject(Model.Tours));
		const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
		const addToCartUrl = '@Url.Action("AddToCart", "Cart")';
		const loginUrl = '@Url.Action("Login", "Account")';

		const tourCardsEl = document.getElementById('tourCards');
		const searchInput = document.getElementById('tourSearch');
		const searchBtn = document.getElementById('tourSearchBtn');
		const startDateInput = document.getElementById('startDate');
		const endDateInput = document.getElementById('endDate');
		const priceLimitSelect = document.getElementById('priceLimit');
		const cartToast = document.getElementById('cartToast');
		const cartCountEl = document.getElementById('cart-count');
		const modal = new bootstrap.Modal(document.getElementById('tourDetailModal'));
		const modalTitle = document.getElementById('tourDetailTitle');
		const modalBody = document.getElementById('tourDetailBody');
		const modalSlots = document.getElementById('tourDetailSlots');
		const modalAddCartButton = document.getElementById('modalAddCartButton');

		let currentModalTourId = null;

		// Initialize datepickers
		$('#startDate, #endDate').datepicker({
			format: 'dd/mm/yyyy',
			autoclose: true,
			todayHighlight: true
		});

		// Tab switching
		document.querySelectorAll('.search-tabs button').forEach(btn => {
			btn.addEventListener('click', (e) => {
				document.querySelectorAll('.search-tabs button').forEach(b => b.classList.remove('active'));
				e.target.classList.add('active');
				// Can add hotel search functionality here if needed
			});
		});

		// Event listeners
		searchBtn.addEventListener('click', filterTours);
		searchInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') {
				e.preventDefault();
				filterTours();
			}
		});
		startDateInput.addEventListener('change', filterTours);
		endDateInput.addEventListener('change', filterTours);
		priceLimitSelect.addEventListener('change', filterTours);

		modalAddCartButton.addEventListener('click', () => {
			if (!currentModalTourId) {
				showCartMessage('Không xác định tour.', false);
				return;
			}
			handleAddToCart(currentModalTourId);
		});

		function renderTours(list) {
			if (!list.length) {
				tourCardsEl.innerHTML = '<div class="col-12"><p class="text-muted text-center py-4">Hiện không có tour phù hợp.</p></div>';
				return;
			}

			tourCardsEl.innerHTML = list.map(tour => `
				<div class="col-12 col-md-6 col-xl-4">
					<div class="card tour-card">
						<img src="${tour.AvatarUrl}" alt="${tour.TourName}" class="card-img-top">
						<div class="card-body d-flex flex-column">
							<p class="badge bg-warning text-dark badge-sold align-self-start mb-2">Đã có ${tour.SoldCount} lượt đặt</p>
							<h5 class="card-title">${tour.TourName}</h5>
							<p class="card-meta text-muted mb-2">${tour.CategoryName}</p>
							<p class="card-text flex-grow-1 text-sm">${tour.Description}</p>
							<ul class="list-unstyled text-sm text-secondary mb-3">
								<li>Thời gian: ${tour.Duration}</li>
								<li>Giá từ: ${formatter.format(tour.Price)}</li>
								<li>Còn ${tour.AvailableSlots} / ${tour.TotalSlots} chỗ</li>
							</ul>
							<div class="d-grid gap-2">
								<button class="btn btn-outline-primary detail-btn w-100" data-tour='${encodeURIComponent(JSON.stringify(tour))}'>View details</button>
							</div>
						</div>
					</div>
				</div>
			`).join('');
			bindDetailButtons();
		}

		function bindDetailButtons() {
			document.querySelectorAll('.detail-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const tour = JSON.parse(decodeURIComponent(btn.dataset.tour));
					currentModalTourId = tour.TourId;
					modalTitle.textContent = tour.TourName;
					modalSlots.textContent = `Còn ${tour.AvailableSlots} / ${tour.TotalSlots} chỗ`;
					modalBody.innerHTML = `
						<div class="mb-3">
							<label class="form-label fw-semibold">Mô tả</label>
							<p>${tour.Description}</p>
						</div>
						<div class="mb-3">
							<label class="form-label fw-semibold">Lịch trình</label>
							${tour.Itinerary.length ? tour.Itinerary.map(item => `
								<div class="itinerary-day">
									<div class="fw-bold">Ngày ${item.DayNumber} – ${item.Title}</div>
									<p class="mb-1">${item.Description}</p>
								</div>
							`).join('') : '<p class="text-muted">Chưa có lịch trình cụ thể.</p>'}
						</div>
						<div class="d-flex flex-wrap align-items-center gap-3">
							<span class="fs-5 fw-semibold text-primary">${formatter.format(tour.Price)}</span>
							<span class="badge bg-success">Thời gian: ${tour.Duration}</span>
						</div>
					`;
					modal.show();
				});
			});
		}

		function filterTours() {
			const term = searchInput.value.trim().toLowerCase();
			const priceLimit = parseInt(priceLimitSelect.value) || 0;

			const filtered = tourData.filter(tour => {
				const matchesTerm = !term || tour.TourName.toLowerCase().includes(term);
				const matchesPrice = priceLimit === 0 || tour.Price <= priceLimit;
				return matchesTerm && matchesPrice;
			});

			renderTours(filtered);
		}

		function handleAddToCart(tourId) {
			fetch(addToCartUrl, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ tourId: tourId, quantity: 1 })
			})
				.then(res => res.json())
				.then(data => {
					if (data.requiresLogin) {
						window.location.href = loginUrl + '?returnUrl=' + encodeURIComponent(window.location.href);
						return;
					}
					if (data.success) {
						showCartMessage(data.message, true);
						if (cartCountEl) cartCountEl.textContent = data.cartCount ?? 0;
						setTimeout(() => {
							const m = bootstrap.Modal.getInstance(document.getElementById('tourDetailModal'));
							if (m) m.hide();
						}, 1500);
					} else {
						showCartMessage(data.message, false);
					}
				})
				.catch(() => showCartMessage('Có lỗi khi thêm vào giỏ hàng.', false));
		}

		function showCartMessage(text, success = true) {
			cartToast.textContent = text;
			cartToast.classList.remove('bg-success', 'bg-danger');
			cartToast.classList.add(success ? 'bg-success' : 'bg-danger');
			cartToast.classList.add('visible');
			setTimeout(() => cartToast.classList.remove('visible'), 3000);
		}

		// Initial render
		renderTours(tourData);
	</script>
}

